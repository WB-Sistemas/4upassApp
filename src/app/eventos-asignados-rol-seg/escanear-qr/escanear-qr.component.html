<ion-header class="app-header">
  <ion-toolbar class="my-toolbar">
    <ion-buttons slot="start">
      <ion-button fill="clear" color="light" (click)="goBack()">
        <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="titulo">Control De Entradas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen class="scan-content">

  <div class="scanner-page" [class.scanner-hidden]="camaraActive && isNativeScanner">
    <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
      <ion-refresher-content></ion-refresher-content>
    </ion-refresher>

    <div class="ion-text-center ion-margin-bottom escaneos-container">
      <ion-card>
        <ion-card-content>
          <ion-text>
            <h4>Escaneos</h4>
            <h1>{{ escaneados }}/{{ total }}</h1>
          </ion-text>
        </ion-card-content>
      </ion-card>
    </div>

    <ion-card *ngIf="seccionesOptions.length > 0">
      <ion-card-content>
          <ion-item>
            <ion-label>Seccion</ion-label>
            <ion-select
              [value]="seccionSelected"
              placeholder="Seleccione seccion"
              (ionChange)="seccionOnChange($event)"
              cancelText="Cancelar"
              okText="OK"
              [interfaceOptions]="selectAlertOpts"
            >
              <ion-select-option *ngFor="let sec of seccionesOptions" [value]="sec.num">{{ sec.nombre }}</ion-select-option>
            </ion-select>
          </ion-item>
      </ion-card-content>
    </ion-card>
    <!-- Botón Buscar Entrada para desktop -->
    <ng-container *ngIf="!isMobile">
      <div class="cont-bot">
        <ion-button expand="block" (click)="redirect()">Buscar Entrada</ion-button>
      </div>
    </ng-container>

    <ion-card class="scan-card">
      <ion-card-content>

        <!-- Formulario input con margen abajo -->
        <form [formGroup]="form" class="form-referencia">
          <ion-item>
            <ion-input formControlName="idReferencia" maxlength="10" placeholder="Id Referencia"></ion-input>
          </ion-item>
        </form>

        <!-- Botones juntos con separación -->
        <div class="cont-bot botones-accion">
          <ion-button expand="block" color="medium" (click)="switchQr()">
            Habilitar Cámara
          </ion-button>

          <ion-button expand="block" (click)="redirect()" class="mi-boton no-effects" >
            Buscar Entrada
          </ion-button>
        </div>

        <!-- Contenedor para el QR, con margen arriba -->
        <div class="cont-qr" *ngIf="camaraActive">
          <app-qr 
            [encendido]="camaraActive"
            (valor)="procesarValor($event)"
            (devices)="initCameras($event)"
          ></app-qr>
        </div>

      </ion-card-content>
    </ion-card>
  </div>

  <div class="native-scanner-overlay" *ngIf="camaraActive && isNativeScanner">
    <div class="native-scanner-top">
      <p class="native-title">Apunta el QR dentro del marco</p>
    </div>
    <div class="native-scanner-frame">
      <span class="corner tl"></span>
      <span class="corner tr"></span>
      <span class="corner bl"></span>
      <span class="corner br"></span>
      <span class="scan-line"></span>
    </div>
    <div class="native-scanner-actions">
      <ion-button expand="block" class="native-close" (click)="desactivarQr()">
        Cerrar
      </ion-button>
    </div>
  </div>

  <!-- ✅ Modal de Éxito -->
  <div *ngIf="modalActive && exitoso" class="modal-overlay" style="display: flex; justify-content: center; align-items: center;">
    <div class="modal-content border-green">
      <div class="icon-container">
        <img src="/assets/confirmData.svg" alt="Éxito" class="icon-success" />
      </div>
      <div class="info fw-bold">
        <p class="nombre" style="font-size: 20px; font-weight: 700; margin: 0px 0px 10px 0px; text-align: start;">{{datosEntradaExito?.name}}</p>
        <div class="doc">
          <p class="sub-title" style="color: #ada5bd; text-align: start; margin: 0px;">{{ tipoIdentificacionNombre }}:</p>
          <p style="text-align: start; color: #212529;  margin: 0px;">{{ datosEntradaExito?.numeroDNI }}</p>
          <p class="sub-title" style="color: #ada5bd; text-align: start;  margin: 0px;" >ID:</p>
          <p style="text-align: start; color: #212529; margin: 0px; ">{{ datosEntradaExito?.idLegible }}</p>
          <p class="sub-title" style="color: #ada5bd; text-align: start;  margin: 0px;" >Funcion:</p>
          <p style="text-align: start; color: #212529; margin: 0px; ">{{datosEntradaExito?.fecha | date}}</p>
          <p class="sub-title" style="color: #ada5bd; text-align: start; margin: 0px;" >Tipo de Precio: </p>
          <p style="text-align: start; color: #212529; margin: 0px;">{{datosEntradaExito?.nombre}}</p>
          <p class="sub-title" style="color: #ada5bd; text-align: start; margin: 0px;" >Sector:</p>
          <p class="text-wrap" style="margin: 0px; text-align: start; color: #212529">{{ datosEntradaExito?.nombreSector  }}</p>
          <p class="sub-title" style="color: #ada5bd; text-align: start;  margin: 0px;" *ngIf="datosEntradaExito?.nombreFila">Fila: </p>
          <p class="text-wrap" style="margin: 0px; text-align: start; color: #212529" >{{datosEntradaExito?.nombreFila}}</p>
          <p class="sub-title" style="color: #ada5bd; text-align: start;  margin: 0px;" *ngIf="datosEntradaExito?.nombreAsiento">Butaca: </p>
          <p class="text-wrap" style="margin: 0px; text-align: start; color: #212529">{{datosEntradaExito?.nombreAsiento}}</p>
        </div>
      </div>
      <div class="actions mt-4">
        <ion-button expand="block" fill="outline" (click)="cerrarModal()" class="boton-cerrar">
        Cerrar
        </ion-button>
        <ion-button expand="block" color="success" (click)="confirmScan()" class="boton-aceptar">
        Escanear
        </ion-button>
      </div>
    </div>
  </div>

  <!-- ❌ Modal de Error -->
  <div *ngIf="modalActive && !exitoso" class="modal-overlay" style="display: flex; justify-content: center; align-items: center;">
    <div class="modal-content border-red">
      <div class="icon-container">
        <img src="assets/errorScan.svg" alt="Error" class="icon-success" />
      </div>
      <div class="info-error fw-bold mt-4 w-100" [ngClass]="{ 'padd-per': !datosEntradaError && !fechaExpiracion && !isErrorSeccion }">
        <p class="error w-100">{{ mensajeError || 'Error inesperado' }}</p>

        <div *ngIf="isErrorSeccion && errorSeccionSub" class="details mt-4 mb-3">
          <div class="icons w-100 justify-content-center">
            <div class="data-error">
              <p class="sub-title" style="margin: 0px; text-align: center;">{{ errorSeccionSub }}</p>
            </div>
          </div>
        </div>
        <div *ngIf="isErrorSeccion && datosSeccionError && !errorSeccionSub" class="details mt-4 mb-3">
          <div class="icons">
            <div class="icon-cont">
              <ion-icon name="time-outline"></ion-icon>
            </div>
            <div class="data-error">
              <p class="sub-title" style="margin: 0px;">{{ datosSeccionError?.scanTime | date: "dd-LLL-yyyy" }}</p>
              <p class="detail-error">{{ horaDeScan ? (horaDeScan | date: "HH:mm'hs'") : '' }}</p>
            </div>
          </div>
          <div class="icons">
            <div class="icon-cont">
              <ion-icon name="person-outline"></ion-icon>
            </div>
            <div class="data-error">
              <p class="sub-title" style="margin: 0px;">Escaneado Por</p>
              <p class="detail-error">{{ datosSeccionError?.nameScanBy }}</p>
            </div>
          </div>
        </div>

        <!-- Datos de escaneo -->
        <div *ngIf="datosEntradaError" class="details mt-4 mb-3">
          <div class="icons">
            <div class="icon-cont">
              <ion-icon name="time-outline"></ion-icon>
            </div>
            <div class="data-error">
              <p class="sub-title" style="margin: 0px;">{{ datosEntradaError?.scanTime | date: "dd-LLL-yyyy" }}</p>
              <p class="detail-error">{{ horaDeScan ? (horaDeScan | date: "HH:mm'hs'") : '' }}</p>
            </div>
          </div>
          <div class="icons">
            <div class="icon-cont">
              <ion-icon name="person-outline"></ion-icon>
            </div>
            <div class="data-error">
              <p class="sub-title" style="margin: 0px;">Escaneado Por</p>
              <p class="detail-error">{{ datosEntradaError?.nameScanBy }}</p>
            </div>
          </div>
        </div>

        <ion-button expand="block" class="boton-rojito" (click)="closeModal()">
          Cerrar
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Modal de Expiración -->
  <div *ngIf="modalExpiradoActive" class="expiry-overlay">
    <div class="expiry-card">
      <div class="expiry-icon-circle">
        <img src="assets/errorScan.svg" alt="Error" />
      </div>
      <div class="expiry-modal">
        <div class="expiry-body">
          <p class="expiry-title">Entrada expirada.</p>
          <p class="expiry-subtitle">Válida hasta</p>

          <div *ngIf="fechaExpiracion; else missingDate" class="expiry-date-row">
            <div class="expiry-icon">
              <ion-icon name="time-outline"></ion-icon>
            </div>
            <div class="expiry-date-text">
              <p class="expiry-date">{{ fechaExpiracion | date: "dd-LLL-yyyy" }}</p>
              <p class="expiry-time">{{ fechaExpiracion | date: "HH:mm'hs'" }}</p>
            </div>
          </div>
          <ng-template #missingDate>
            <p class="expiry-missing">Fecha no disponible</p>
          </ng-template>
        </div>
      </div>
      <ion-button expand="block" class="expiry-close" (click)="closeExpiredModal()">Cerrar</ion-button>
    </div>
  </div>

</ion-content>
